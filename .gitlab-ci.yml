# GitLab CI/CD for building and pushing Docker image to Harbor using Kaniko

stages:
  - build-and-push

variables:
  HARBOR_REGISTRY: harbor.test.shopeemobile.com
  HARBOR_PROJECT: knowledgebot
  IMAGE_NAME: knowledgebot
  IMAGE_TAG: ${HARBOR_REGISTRY}/${HARBOR_PROJECT}/${IMAGE_NAME}

# Build and push Docker image using Kaniko (no Docker daemon needed)
build-and-push:
  stage: build-and-push
  image:
    name: gcr.io/kaniko-project/executor:latest
    entrypoint: [""]
  script:
    - echo "Building and pushing Docker image to Harbor..."
    - /kaniko/executor --context $CI_PROJECT_DIR --dockerfile $CI_PROJECT_DIR/Dockerfile --destination=${IMAGE_TAG}:latest --destination=${IMAGE_TAG}:${CI_COMMIT_SHORT_SHA} --destination=${IMAGE_TAG}:${CI_COMMIT_REF_SLUG} --cache=true --cache-ttl=24h --skip-tls-verify --username="$HARBOR_USERNAME" --password="$HARBOR_PASSWORD"
    - |
      if [ -n "$CI_COMMIT_TAG" ]; then
        echo "Pushing version tags: ${CI_COMMIT_TAG} and $(echo $CI_COMMIT_TAG | sed 's/^v//')"
        /kaniko/executor --context $CI_PROJECT_DIR --dockerfile $CI_PROJECT_DIR/Dockerfile --destination=${IMAGE_TAG}:${CI_COMMIT_TAG} --destination=${IMAGE_TAG}:$(echo $CI_COMMIT_TAG | sed 's/^v//') --cache=true --cache-ttl=24h --skip-tls-verify --username="$HARBOR_USERNAME" --password="$HARBOR_PASSWORD"
      fi
    - echo "Build and push completed successfully!"
    - echo "Image available at: ${IMAGE_TAG}:latest"
  rules:
    - if: $CI_COMMIT_BRANCH == "master"
    - if: $CI_COMMIT_TAG
