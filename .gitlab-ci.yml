# GitLab CI/CD for building and pushing Docker image to Harbor

stages:
  - build
  - push

variables:
  HARBOR_REGISTRY: harbor.test.shopeemobile.com
  HARBOR_PROJECT: knowledgebot
  IMAGE_NAME: knowledgebot
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"

# Build Docker image
build:
  stage: build
  image: docker:24-dind
  services:
    - docker:24-dind
  before_script:
    - docker info
    - echo "Logging in to Harbor..."
    - echo "$HARBOR_PASSWORD" | docker login -u "$HARBOR_USERNAME" --password-stdin $HARBOR_REGISTRY
  script:
    - echo "Building Docker image..."
    - |
      IMAGE_TAG="${HARBOR_REGISTRY}/${HARBOR_PROJECT}/${IMAGE_NAME}"
      
      # Build with multiple tags
      docker build \
        --tag ${IMAGE_TAG}:latest \
        --tag ${IMAGE_TAG}:${CI_COMMIT_SHORT_SHA} \
        --tag ${IMAGE_TAG}:${CI_COMMIT_REF_SLUG} \
        .
      
      # Add version tag if it's a tag commit
      if [ -n "$CI_COMMIT_TAG" ]; then
        docker tag ${IMAGE_TAG}:latest ${IMAGE_TAG}:${CI_COMMIT_TAG}
        docker tag ${IMAGE_TAG}:latest ${IMAGE_TAG}:$(echo $CI_COMMIT_TAG | sed 's/^v//')
      fi
      
      echo "Build completed successfully!"
      docker images | grep ${IMAGE_NAME}
  rules:
    - if: $CI_COMMIT_BRANCH
    - if: $CI_COMMIT_TAG
  tags:
    - docker

# Push Docker image to Harbor
push:
  stage: push
  image: docker:24-dind
  services:
    - docker:24-dind
  dependencies:
    - build
  before_script:
    - docker info
    - echo "Logging in to Harbor..."
    - echo "$HARBOR_PASSWORD" | docker login -u "$HARBOR_USERNAME" --password-stdin $HARBOR_REGISTRY
  script:
    - echo "Pushing Docker image to Harbor..."
    - |
      IMAGE_TAG="${HARBOR_REGISTRY}/${HARBOR_PROJECT}/${IMAGE_NAME}"
      
      # Push all tags
      docker push ${IMAGE_TAG}:latest
      docker push ${IMAGE_TAG}:${CI_COMMIT_SHORT_SHA}
      docker push ${IMAGE_TAG}:${CI_COMMIT_REF_SLUG}
      
      # Push version tag if it's a tag commit
      if [ -n "$CI_COMMIT_TAG" ]; then
        docker push ${IMAGE_TAG}:${CI_COMMIT_TAG}
        docker push ${IMAGE_TAG}:$(echo $CI_COMMIT_TAG | sed 's/^v//')
      fi
      
      echo "Push completed successfully!"
      echo "Image available at: ${IMAGE_TAG}:latest"
  rules:
    - if: $CI_COMMIT_BRANCH == "master"
    - if: $CI_COMMIT_TAG
  tags:
    - docker

