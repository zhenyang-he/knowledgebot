stages:
  - build
  - docker-build

variables:
  HARBOR_REGISTRY: harbor.test.shopeemobile.com
  HARBOR_PROJECT: knowledgebot
  IMAGE_NAME: knowledgebot
  IMAGE_TAG: "${HARBOR_REGISTRY}/${HARBOR_PROJECT}/${IMAGE_NAME}"
  GO_VERSION: "1.20"

# Build the Go binary
build-binary:
  stage: build
  image: golang:${GO_VERSION}-alpine
  before_script:
    - apk add --no-cache git
  script:
    - echo "Building Go binary..."
    - go mod download
    - CGO_ENABLED=0 GOOS=linux go build -o knowledgebot main.go
    - ls -lh knowledgebot
  artifacts:
    paths:
      - knowledgebot
    expire_in: 1 hour
  rules:
    - if: $CI_COMMIT_BRANCH == "master"
    - if: $CI_COMMIT_TAG

# Build and push Docker image using Podman
docker-build:
  stage: docker-build
  image: quay.io/podman/stable:latest
  dependencies:
    - build-binary
  timeout: 30m
  before_script:
    - echo "Preparing to build Docker image..."
    - podman version
    - echo "Logging in to Harbor..."
    - echo "$HARBOR_PASSWORD" | podman login -u "$HARBOR_USERNAME" --password-stdin $HARBOR_REGISTRY
  script:
    - echo "Building Docker image..."
    - podman build --tag ${IMAGE_TAG}:latest --tag ${IMAGE_TAG}:${CI_COMMIT_SHORT_SHA} --tag ${IMAGE_TAG}:${CI_COMMIT_REF_SLUG} -f Dockerfile.runtime .
    - |
      if [ -n "$CI_COMMIT_TAG" ]; then
        podman tag ${IMAGE_TAG}:latest ${IMAGE_TAG}:${CI_COMMIT_TAG}
        podman tag ${IMAGE_TAG}:latest ${IMAGE_TAG}:$(echo $CI_COMMIT_TAG | sed 's/^v//')
      fi
    - echo "Pushing Docker image to Harbor..."
    - podman push ${IMAGE_TAG}:latest
    - podman push ${IMAGE_TAG}:${CI_COMMIT_SHORT_SHA}
    - podman push ${IMAGE_TAG}:${CI_COMMIT_REF_SLUG}
    - |
      if [ -n "$CI_COMMIT_TAG" ]; then
        podman push ${IMAGE_TAG}:${CI_COMMIT_TAG}
        podman push ${IMAGE_TAG}:$(echo $CI_COMMIT_TAG | sed 's/^v//')
      fi
    - echo "Build and push completed successfully!"
  rules:
    - if: $CI_COMMIT_BRANCH == "master"
    - if: $CI_COMMIT_TAG
