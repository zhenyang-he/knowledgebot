stages:
  - test
  - build
  - push

variables:
  HARBOR_REGISTRY: harbor.test.shopeemobile.com
  HARBOR_PROJECT: knowledgebot
  IMAGE_NAME: knowledgebot
  IMAGE_TAG: "${HARBOR_REGISTRY}/${HARBOR_PROJECT}/${IMAGE_NAME}"

# Simple test job - no Docker, just to verify pipeline works
test:
  stage: test
  image: alpine:latest
  script:
    - echo "Testing pipeline without Docker build..."
    - 'echo "Current directory: $(pwd)"'
    - 'echo "Files in directory:"'
    - ls -la
    - echo "Test completed successfully!"
  rules:
    - if: $CI_COMMIT_BRANCH == "master"
    - if: $CI_COMMIT_TAG

# Build Docker image using Kaniko (without pushing)
build:
  stage: build
  image:
    name: gcr.io/kaniko-project/executor:latest
  timeout: 20m
  before_script:
    - echo "Preparing to build Docker image..."
    - 'echo "Build context: $CI_PROJECT_DIR"'
    - ls -la $CI_PROJECT_DIR
    - echo "Dockerfile exists:" && test -f $CI_PROJECT_DIR/Dockerfile && echo "YES" || echo "NO"
  script:
    - echo "Building Docker image (not pushing yet)..."
    - echo "Starting build at $(date)"
    - /kaniko/executor --context $CI_PROJECT_DIR --dockerfile $CI_PROJECT_DIR/Dockerfile --no-push --tarPath=image.tar --cache=true --cache-ttl=24h --verbosity=debug --log-format=text
    - echo "Build completed at $(date)"
    - ls -lh image.tar 2>/dev/null || echo "No tar file created"
  artifacts:
    paths:
      - image.tar
    expire_in: 1 hour
  rules:
    - if: $CI_COMMIT_BRANCH == "master"
    - if: $CI_COMMIT_TAG
  when: manual

# Push Docker image to Harbor (separate stage)
push:
  stage: push
  image:
    name: gcr.io/kaniko-project/executor:latest
  timeout: 10m
  dependencies:
    - build
  before_script:
    - echo "Preparing to push Docker image to Harbor..."
  script:
    - echo "Pushing Docker image to Harbor..."
    - echo "Starting push at $(date)"
    - /kaniko/executor --context $CI_PROJECT_DIR --dockerfile $CI_PROJECT_DIR/Dockerfile --destination=${IMAGE_TAG}:latest --destination=${IMAGE_TAG}:${CI_COMMIT_SHORT_SHA} --destination=${IMAGE_TAG}:${CI_COMMIT_REF_SLUG} --skip-tls-verify --username="$HARBOR_USERNAME" --password="$HARBOR_PASSWORD" --verbosity=debug --log-format=text
    - echo "Push completed at $(date)"
  rules:
    - if: $CI_COMMIT_BRANCH == "master"
    - if: $CI_COMMIT_TAG
  when: manual
