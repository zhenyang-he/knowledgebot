stages:
  - build-and-push

variables:
  HARBOR_REGISTRY: harbor.test.shopeemobile.com
  HARBOR_PROJECT: knowledgebot
  IMAGE_NAME: knowledgebot
  IMAGE_TAG: "${HARBOR_REGISTRY}/${HARBOR_PROJECT}/${IMAGE_NAME}"
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"

# Build and push Docker image using Docker
build-and-push:
  stage: build-and-push
  image: docker:24
  services:
    - docker:24-dind
  before_script:
    - echo "Preparing to build Docker image..."
    - docker info
    - echo "Logging in to Harbor..."
    - echo "$HARBOR_PASSWORD" | docker login -u "$HARBOR_USERNAME" --password-stdin $HARBOR_REGISTRY
  script:
    - echo "Building Docker image..."
    - docker build -t ${IMAGE_TAG}:latest -t ${IMAGE_TAG}:${CI_COMMIT_SHORT_SHA} -t ${IMAGE_TAG}:${CI_COMMIT_REF_SLUG} .
    - |
      if [ -n "$CI_COMMIT_TAG" ]; then
        docker tag ${IMAGE_TAG}:latest ${IMAGE_TAG}:${CI_COMMIT_TAG}
        docker tag ${IMAGE_TAG}:latest ${IMAGE_TAG}:$(echo $CI_COMMIT_TAG | sed 's/^v//')
      fi
    - echo "Pushing Docker image to Harbor..."
    - docker push ${IMAGE_TAG}:latest
    - docker push ${IMAGE_TAG}:${CI_COMMIT_SHORT_SHA}
    - docker push ${IMAGE_TAG}:${CI_COMMIT_REF_SLUG}
    - |
      if [ -n "$CI_COMMIT_TAG" ]; then
        docker push ${IMAGE_TAG}:${CI_COMMIT_TAG}
        docker push ${IMAGE_TAG}:$(echo $CI_COMMIT_TAG | sed 's/^v//')
      fi
    - echo "Build and push completed successfully!"
  rules:
    - if: $CI_COMMIT_BRANCH == "master"
    - if: $CI_COMMIT_TAG
