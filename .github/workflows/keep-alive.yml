name: Keep Service Alive

on:
  schedule:
    # Run every 7 minutes (GitHub Actions minimum interval)
    - cron: '*/7 * * * *'
  workflow_dispatch: # Allow manual triggering

jobs:
  ping-health:
    runs-on: ubuntu-latest
    steps:
      - name: Random delay (0-7 minutes)
        run: |
          # Generate random delay between 0-7 minutes (420 seconds)
          DELAY=$((RANDOM % 420))
          echo "Waiting $DELAY seconds (random delay 0-7 minutes)"
          sleep $DELAY
      
      - name: Ping health endpoint
        env:
          SERVICE_URL: ${{ secrets.RENDER_SERVICE_URL }}
        run: |
          if [ -z "$SERVICE_URL" ]; then
            echo "❌ Error: RENDER_SERVICE_URL secret is not set"
            echo "Please set it in: Repository Settings → Secrets and variables → Actions"
            exit 1
          fi
          
          echo "Pinging $SERVICE_URL/health..."
          
          # Ping with 60 second timeout to handle cold starts
          response=$(curl -s -w "\nHTTP_CODE:%{http_code}\nTIME:%{time_total}" \
            --max-time 60 \
            "$SERVICE_URL/health" || echo "HTTP_CODE:000")
          
          http_code=$(echo "$response" | grep "HTTP_CODE" | cut -d: -f2)
          time_total=$(echo "$response" | grep "TIME" | cut -d: -f2)
          
          if [ "$http_code" = "200" ]; then
            echo "✅ Health check successful (HTTP $http_code, ${time_total}s)"
            echo "$response" | grep -v "HTTP_CODE\|TIME"
          else
            echo "❌ Health check failed (HTTP $http_code)"
            exit 1
          fi

